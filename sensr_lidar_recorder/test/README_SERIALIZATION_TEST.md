# 직렬화 메모리 프로파일링 테스트

## 목적

`serialize_message()`가 메모리 누수의 주원인인지 확인하는 테스트입니다.

## 테스트 파일

- `main_serialization_test.py`: 직렬화 메모리 프로파일링 테스트

## 🧪 테스트 종류

### 1. 더미 데이터 테스트 (빠른 테스트, 추천)

**목적**: serialize_message() 자체의 메모리 동작 확인

**특징**:
- 실제 센서 없이 테스트 가능
- 더미 포인트클라우드 생성하여 직렬화
- 직렬화 전/후/삭제 후 메모리 추적

**실행 방법**:
```bash
cd test

# 기본 테스트 (100회 반복, 10,000 포인트)
python main_serialization_test.py --test-type dummy

# 커스텀 설정
python main_serialization_test.py --test-type dummy --iterations 200 --points 50000
```

**예상 실행 시간**: 1~5분

**파라미터**:
- `--iterations`: 반복 횟수 (기본: 100)
- `--points`: 포인트클라우드 점 개수 (기본: 10,000)

**출력 예시**:
```
======================================================================
🔬 직렬화 메모리 누수 테스트
======================================================================
반복 횟수: 100
포인트 개수: 10,000
======================================================================

📊 초기 메모리: 145.2 MB

[ 10] 메모리:  156.3 MB | 증가:   11.1 MB | 평균:  1.11 MB/iter | 직렬화 차이:  0.85 MB | 삭제 차이: -0.12 MB
[ 20] 메모리:  167.8 MB | 증가:   22.6 MB | 평균:  1.13 MB/iter | 직렬화 차이:  0.87 MB | 삭제 차이: -0.10 MB
[ 30] 메모리:  179.2 MB | 증가:   34.0 MB | 평균:  1.13 MB/iter | 직렬화 차이:  0.86 MB | 삭제 차이: -0.11 MB
      🗑️  GC 실행: 12개 객체 수집
...

======================================================================
📊 최종 결과
======================================================================
초기 메모리:   145.2 MB
최종 메모리:   259.8 MB
총 증가량:     114.6 MB
평균 증가율:   1.15 MB/iteration
======================================================================
```

---

### 2. 실제 데이터 테스트 (센서 필요)

**목적**: 실제 SENSR 데이터로 직렬화 메모리 동작 확인

**특징**:
- 실제 센서 데이터 사용
- 네트워크 수신 + 직렬화 통합 테스트
- 메모리 증가율 정밀 측정

**실행 방법**:
```bash
cd test

# 5분 테스트 (기본)
python main_serialization_test.py --test-type real --duration 300 --host samyang

# 10분 테스트
python main_serialization_test.py --test-type real --duration 600 --host samyang
```

**예상 실행 시간**: 5~10분

**파라미터**:
- `--duration`: 테스트 시간 (초, 기본: 300)
- `--host`: SENSR 호스트 ID (기본: samyang)

**출력 예시**:
```
======================================================================
🔬 실제 데이터 직렬화 메모리 테스트
======================================================================
호스트: samyang
시간: 300초
======================================================================

📊 초기 메모리: 142.5 MB

⏱️    5.0초 | 메모리:  158.3 MB | 증가:   15.8 MB | 증가율: 189.6 MB/분 | 메시지: 45
⏱️   10.0초 | 메모리:  174.1 MB | 증가:   31.6 MB | 증가율: 189.6 MB/분 | 메시지: 89
      🗑️  GC 실행: 8개 객체 수집
⏱️   15.0초 | 메모리:  189.8 MB | 증가:   47.3 MB | 증가율: 189.2 MB/분 | 메시지: 134
...

======================================================================
📊 최종 결과
======================================================================
총 실행 시간:   5.0분
초기 메모리:     142.5 MB
최종 메모리:     1,087.3 MB
총 증가량:       944.8 MB
분당 증가율:     188.9 MB/분

메시지 통계:
  - 총 메시지:   1342
  - 직렬화:      1342
  - 포인트클라우드: 38
  - Output Data: 98

직렬화 시간:
  - 평균: 2.45 ms
  - 최대: 45.67 ms
======================================================================
```

---

## 📊 분석 방법

### 1. 더미 테스트 결과 분석

**메모리 누수 판단 기준**:

| 평균 증가율 | 평가 | 의미 |
|------------|------|------|
| < 0.5 MB/iter | ✅ 정상 | serialize_message()는 문제 없음 |
| 0.5~1.0 MB/iter | ⚠️ 주의 | 약간의 누수 가능성 |
| > 1.0 MB/iter | 🔴 문제 | serialize_message()가 메모리 누수 원인 |

**확인할 지표**:
1. **직렬화 차이**: `mem_after_serialize - mem_before_serialize`
   - 직렬화 과정에서 증가하는 메모리
   - 정상: 0.5~1.0 MB (메시지 크기에 따라)

2. **삭제 차이**: `mem_after_delete - mem_after_serialize`
   - `del` 후 메모리 해제량
   - 정상: 음수 (메모리 감소)
   - 문제: 0 또는 양수 (메모리 해제 안 됨)

3. **총 증가량**:
   - 정상: GC 후 초기값으로 돌아감
   - 문제: 계속 증가

### 2. 실제 데이터 테스트 결과 분석

**비교 대상**: Test 4/5 결과 (277~285 MB/분)

| 실제 데이터 증가율 | 평가 | 결론 |
|------------------|------|------|
| < 100 MB/분 | ✅ serialize_message()는 문제 없음 | 다른 원인 찾기 |
| 100~200 MB/분 | ⚠️ serialize_message()가 일부 원인 | 최적화 필요 |
| > 200 MB/분 | 🔴 serialize_message()가 주원인 | 대안 필요 (멀티프로세스) |

**Test 5와 비교**:
```
Test 5 (최적화 + Duration 60): 277.5 MB/분
실제 데이터 테스트 결과:       ??? MB/분

차이 분석:
- 비슷함 (250~300 MB/분): serialize_message()가 주원인
- 훨씬 낮음 (< 150 MB/분): serialize_message() 외에 다른 원인 존재
```

---

## 🔍 예상 시나리오

### 시나리오 1: serialize_message()가 주원인

**테스트 결과**:
- 더미 테스트: 1.0 MB/iter 이상
- 실제 데이터: 200~300 MB/분

**결론**:
- ✅ 원인 확정: rclpy의 CDR 직렬화가 메모리 누수
- 🔴 해결책: 멀티프로세스 아키텍처 또는 C++ 재작성 필수

### 시나리오 2: serialize_message()는 정상

**테스트 결과**:
- 더미 테스트: < 0.5 MB/iter
- 실제 데이터: < 100 MB/분

**결론**:
- ❌ serialize_message()는 원인 아님
- 🔍 다른 원인 조사 필요:
  1. Bag Writer 내부 (SQLite3)
  2. Data Processor의 Protobuf 파싱
  3. 메시지 큐 관리

### 시나리오 3: 복합 원인

**테스트 결과**:
- 더미 테스트: 0.5~1.0 MB/iter
- 실제 데이터: 150~200 MB/분

**결론**:
- ⚠️ serialize_message()가 일부 원인이지만 전부는 아님
- 🔧 최적화 필요:
  1. 직렬화 후 즉시 삭제 강화
  2. GC 주기 단축 (30초 → 10초)
  3. 메시지 큐 크기 축소 (50 → 20)

---

## 📋 테스트 체크리스트

### 1. 더미 테스트 (필수)
```bash
# 기본 테스트
python main_serialization_test.py --test-type dummy

# 대용량 테스트 (50,000 포인트)
python main_serialization_test.py --test-type dummy --iterations 100 --points 50000
```

**확인 사항**:
- [ ] 평균 증가율이 1.0 MB/iter 미만인가?
- [ ] GC 후 메모리가 감소하는가?
- [ ] 삭제 후 메모리가 해제되는가?

### 2. 실제 데이터 테스트 (센서 켜진 후)
```bash
# 5분 테스트
python main_serialization_test.py --test-type real --duration 300 --host samyang
```

**확인 사항**:
- [ ] 분당 증가율이 Test 5 (277.5 MB/분)와 비슷한가?
- [ ] 포인트클라우드 메시지 수신 정상인가?
- [ ] GC 실행 후 메모리 감소 효과가 있는가?

---

## 🎯 다음 단계

### serialize_message()가 주원인인 경우
→ **멀티프로세스 아키텍처 프로토타입 작성**

### serialize_message()는 정상인 경우
→ **Bag Writer (SQLite3) 또는 Data Processor 조사**

### 복합 원인인 경우
→ **직렬화 최적화 + GC 튜닝**

---

## 📝 참고

**테스트 로그 저장**:
```bash
python main_serialization_test.py --test-type dummy 2>&1 | tee serialization_test_dummy.log
python main_serialization_test.py --test-type real --duration 300 2>&1 | tee serialization_test_real.log
```

**메모리 상세 모니터링** (별도 터미널):
```bash
watch -n 1 'ps aux | grep main_serialization_test | grep -v grep'
```

---

**작성일**: 2025-11-07
**목적**: serialize_message() 메모리 누수 여부 확인
